# å­—æ®µæå–ä¼˜åŒ–æ–¹æ¡ˆ

## æµ‹è¯•æ—¥æœŸ
2025-12-18

## ä¼˜åŒ–ç›®æ ‡
ä¼˜åŒ–BtreeKeyGeneratorçš„å­—æ®µæå–æ€§èƒ½ï¼Œå‡å°‘æ–‡æ¡£éå†æ¬¡æ•°å’Œå­—ç¬¦ä¸²æ¯”è¾ƒå¼€é”€ã€‚

## é˜¶æ®µè§„åˆ’

| é˜¶æ®µ | æ–¹æ¡ˆ | é€‚ç”¨åœºæ™¯ | é¢„æœŸæ•ˆæœ |
|-----|------|---------|---------|
| é˜¶æ®µ1 | é•¿åº¦ä½å›¾+æå‰é€€å‡º | å•ç´¢å¼• | 1.14x-1.57x |
| é˜¶æ®µ2 | åµŒå¥—å­—æ®µå‰ç¼€åˆ†ç»„ | åµŒå¥—ç´¢å¼• | 2-3x |
| é˜¶æ®µ3 | æ•°ç»„å»¶è¿Ÿå±•å¼€ | å¤šé”®ç´¢å¼• | 2-4x |
| é˜¶æ®µ4 | è·¨ç´¢å¼•å…±äº«(ç­¾åæ§½ä½) | å¤šç´¢å¼• | 3-10x |

---

## é˜¶æ®µ1: é•¿åº¦ä½å›¾+æå‰é€€å‡º

### æ ¸å¿ƒé€»è¾‘éªŒè¯ç»“æœ

```
åœºæ™¯                        åŸºçº¿(ns)  ä¼˜åŒ–(ns)  åŠ é€Ÿæ¯”
---------------------------------------------------------
30å­—æ®µæ–‡æ¡£, 3å­—æ®µç´¢å¼•        31.9      20.3     1.57x âœ“
30å­—æ®µæ–‡æ¡£, 6å­—æ®µç´¢å¼•        68.3      52.0     1.31x âœ“
50å­—æ®µæ–‡æ¡£, 6å­—æ®µç´¢å¼•        98.4      86.1     1.14x âœ“
50å­—æ®µæ–‡æ¡£, 10å­—æ®µç´¢å¼•      171.3     150.3     1.14x âœ“
```

### æŠ€æœ¯æ–¹æ¡ˆ

```cpp
class BtreeKeyGeneratorV1 {
    // ç®€å•å­—æ®µï¼ˆæ— "."ï¼‰çš„é•¿åº¦ä½å›¾
    uint64_t _simpleLengthBitmap = 0;

    struct SimpleFieldInfo {
        size_t fieldIndex;
        size_t nameLen;
        const char* name;
    };
    std::vector<SimpleFieldInfo> _simpleFields;
};

// åœ¨getKeysImplä¸­
void preExtractSimpleFields(const BSONObj& obj,
                            std::vector<BSONElement>& fixed,
                            std::vector<const char*>& fieldNames) {
    size_t foundCount = 0;
    size_t targetCount = _simpleFields.size();

    for (BSONObjIterator it(obj); it.more() && foundCount < targetCount; ) {
        BSONElement e = it.next();
        size_t len = e.fieldNameSize() - 1;

        // é•¿åº¦ä½å›¾å¿«é€Ÿè¿‡æ»¤
        if (!(_simpleLengthBitmap & (1ULL << (len & 63)))) {
            continue;
        }

        const char* docFieldName = e.fieldName();
        for (const auto& info : _simpleFields) {
            if (fieldNames[info.fieldIndex][0] == '\0') continue;  // å·²æ‰¾åˆ°

            if (info.nameLen == len &&
                std::memcmp(info.name, docFieldName, len) == 0) {
                fixed[info.fieldIndex] = e;
                fieldNames[info.fieldIndex] = "";
                foundCount++;
                break;
            }
        }
    }
}
```

### å…³é”®ä¼˜åŒ–ç‚¹

1. **é•¿åº¦ä½å›¾é¢„è¿‡æ»¤**: ä¸å¯èƒ½åŒ¹é…çš„é•¿åº¦ç›´æ¥è·³è¿‡
2. **æå‰é€€å‡º**: æ‰¾åˆ°æ‰€æœ‰å­—æ®µååœæ­¢éå†
3. **ä¿ç•™æ—©æœŸç»ˆæ­¢**: ä¸ç ´ågetFieldçš„æ—©æœŸç»ˆæ­¢ä¼˜åŠ¿

---

## å¯¹æ¯”: ç­¾å+unordered_mapæ–¹æ¡ˆ

### å•ç´¢å¼•åœºæ™¯ï¼ˆä¸é€‚ç”¨ï¼‰

```
åœºæ™¯                          åŸºçº¿(ns)  ä¼˜åŒ–(ns)  åŠ é€Ÿæ¯”
---------------------------------------------------------
å°æ–‡æ¡£(20å­—æ®µ), 3å­—æ®µç´¢å¼•       16.6      29.3    0.57x âœ—
ä¸­æ–‡æ¡£(30å­—æ®µ), 6å­—æ®µç´¢å¼•       53.7      89.5    0.60x âœ—
å¤§æ–‡æ¡£(50å­—æ®µ), 10å­—æ®µç´¢å¼•     122.5     199.3    0.61x âœ—
```

åŸå› : unordered_mapå¼€é”€æŠµæ¶ˆäº†ä¼˜åŒ–æ”¶ç›Š

### å¤šç´¢å¼•åœºæ™¯ï¼ˆé˜¶æ®µ4é€‚ç”¨ï¼‰

```
åœºæ™¯                          å”¯ä¸€å­—æ®µ  åŸºçº¿(ns)  ä¼˜åŒ–(ns)  åŠ é€Ÿæ¯”
-----------------------------------------------------------------
1ä¸ªç´¢å¼•Ã—6å­—æ®µ                    6       56.9     159.4    0.36x âœ—
3ä¸ªç´¢å¼•Ã—6å­—æ®µ                   18      217.6     291.7    0.75x âœ—
5ä¸ªç´¢å¼•Ã—6å­—æ®µ                   30      427.5     344.9    1.24x âœ“
7ä¸ªç´¢å¼•Ã—6å­—æ®µ                   36      683.7     354.1    1.93x âœ“
10ä¸ªç´¢å¼•Ã—6å­—æ®µ                  45     1151.5     384.9    2.99x âœ“
7ä¸ªç´¢å¼•Ã—10å­—æ®µ                  50     1308.3     400.5    3.27x âœ“
```

ç»“è®º: ç­¾å+unordered_mapæ–¹æ¡ˆé€‚åˆé˜¶æ®µ4ï¼ˆè·¨ç´¢å¼•å…±äº«ï¼‰ï¼Œä¸é€‚åˆé˜¶æ®µ1

---

## éªŒè¯ä»£ç 

- é˜¶æ®µ1æ ¸å¿ƒé€»è¾‘: `/tmp/stage1_bitmap_only_benchmark.cpp`
- å¤šç´¢å¼•åœºæ™¯: `/tmp/stage1_multi_index_benchmark.cpp`
- ç­¾åæ–¹æ¡ˆ: `/tmp/stage1_signature_benchmark.cpp`

---

## é˜¶æ®µ2: åµŒå¥—å­—æ®µå‰ç¼€åˆ†ç»„

### æ ¸å¿ƒé€»è¾‘éªŒè¯ç»“æœ

```
åœºæ™¯                              åŸºçº¿(ns)  ä¼˜åŒ–(ns)  åŠ é€Ÿæ¯”
-------------------------------------------------------------------
2å­—æ®µå…±äº«å‰ç¼€a                      44.7      27.1     1.65x âœ“
3å­—æ®µå…±äº«å‰ç¼€a                      79.6      47.7     1.67x âœ“
4å­—æ®µå…±äº«å‰ç¼€a,a.d                 117.6      69.3     1.70x âœ“
2å­—æ®µå…±äº«å‰ç¼€x                      41.8      24.5     1.71x âœ“
4å­—æ®µ,2ç»„å‰ç¼€                        86.5      52.3     1.65x âœ“
æ·±åµŒå¥—å…±äº«å‰ç¼€m.n.o                  94.2      67.2     1.40x âœ“
```

### æŠ€æœ¯æ–¹æ¡ˆ

```cpp
// æŒ‰é¦–å­—æ®µåˆ†ç»„
std::map<StringData, std::vector<StringData>> prefixGroups;
for (const auto& path : indexPaths) {
    size_t dot = path.find('.');
    StringData prefix = dot != npos ? path.substr(0, dot) : path;
    StringData suffix = dot != npos ? path.substr(dot + 1) : "";
    prefixGroups[prefix].push_back(suffix);
}

// æå–å…¬å…±å‰ç¼€ä¸€æ¬¡
for (const auto& group : prefixGroups) {
    BSONElement intermediate = obj.getField(group.first);
    if (intermediate.type() == Object) {
        for (const auto& suffix : group.second) {
            // åœ¨ä¸­é—´å¯¹è±¡ä¸Šç»§ç»­æå–
        }
    }
}
```

### å®æ–½å¤æ‚åº¦

- **é«˜å¤æ‚åº¦**: éœ€è¦é‡æ„BtreeKeyGeneratorçš„é€’å½’éå†é€»è¾‘
- **æ•°ç»„å¤„ç†**: å¿…é¡»æ­£ç¡®å¤„ç†æ•°ç»„å±•å¼€åœºæ™¯
- **çŠ¶æ€**: æ ¸å¿ƒéªŒè¯å®Œæˆï¼Œå®æ–½å¾…è¯„ä¼°

---

## å®æ–½çŠ¶æ€

| é˜¶æ®µ | çŠ¶æ€ | å¤‡æ³¨ |
|-----|------|------|
| é˜¶æ®µ1 | âœ… å·²æäº¤ | é•¿åº¦ä½å›¾+æå‰é€€å‡ºï¼Œ1.10x-1.54x |
| é˜¶æ®µ2 | ğŸ”¬ æ ¸å¿ƒéªŒè¯å®Œæˆ | å‰ç¼€åˆ†ç»„ï¼Œ1.40x-1.71xï¼Œå®æ–½å¤æ‚ |
| é˜¶æ®µ3 | å¾…å®æ–½ | |
| é˜¶æ®µ4 | ğŸ”¬ æ ¸å¿ƒéªŒè¯å®Œæˆ | UnifiedFieldExtractorï¼Œ1.93x-3.27x |
