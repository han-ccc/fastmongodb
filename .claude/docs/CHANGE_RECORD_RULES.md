# 改动记录规则

## 重要原则

1. **深入理解原有代码再优化** - 避免重复实现已有功能
2. **记录所有改动** - 每次代码改动都必须记录
3. **定期评估** - 及时回滚无价值的改动
4. **只做有增量价值的优化** - 不要重复造轮子

## 改动记录文件

- 分片路由优化: `SHARDING_OPTIMIZATION_CHANGELOG.md`
- 性能优化: `PERFORMANCE_OPTIMIZATION_LOG.md`

## 记录内容要求

每次改动需记录:
- **改动类型**: 新增/修改/删除
- **改动日期**
- **改动原因**: 为什么做这个改动
- **原有机制分析**: 原有代码是否已有类似功能
- **文件列表**: 涉及的文件
- **价值评估**: 这个改动的实际价值

## 改动前检查清单

```
1. 原有代码是否已有类似功能？
   - 搜索相关代码
   - 理解现有实现机制

2. 这个优化的增量价值是什么？
   - 原有机制不能做什么？
   - 新优化能带来什么改进？

3. 优化应该在哪一层实现？
   - mongos侧还是config server侧？
   - 客户端还是服务端？
```

## 教训记录

| 日期 | 教训 | 详情 |
|-----|------|------|
| 2024-12-16 | 不要重复实现请求合并 | 原有`_hitConfigServerLock`已有类似功能 |
| 2024-12-16 | 不要重复实现增量查询 | 原有`ConfigDiffTracker`已实现 |
| 2024-12-17 | P1字段缓存导致性能退化 | 缓存开销>查找收益 |

## 相关文档

- `SHARDING_OPTIMIZATION_CHANGELOG.md` - 详细改动记录
- `SHARDING_OPTIMIZATION_PLAN.md` - 优化计划
- `src/mongo/s/catalog/SHARDING_OPTIMIZATION_PATCH.md` - 补丁说明
